{% extends 'main.html' %}
<!-- Extend main.html -->

{% block content %}
<div class="container mx-auto mt-8">

    <div class="flex justify-between items-start mb-6">
        <!-- Transaction Table -->
        <h1 class="text-4xl font-bold">Histori Transaksi</h1>

        <div class="flex flex-col space-y-4">
            <!-- Success Message Box -->
            <div id="successBox"
                class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl w-64">
                <p id="successMessage"></p>
            </div>

            <!-- Error Message Box -->
            <div id="errorBox" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl w-64">
                <p id="errorMessage"></p>
            </div>
        </div>
    </div>

    <!-- Transaction Table Container -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="overflow-x-auto">
            <table class="table-auto w-full text-left border-collapse">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">ID</th>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">Item</th>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">Waktu</th>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">Jumlah</th>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">Harga</th>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">Aksi</th>
                    </tr>
                </thead>
                <tbody id="transactionTable" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be dynamically populated here -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div id="paginationControls" class="flex justify-between mt-4">
            <!-- Tombol Previous -->
            <button id="prevPage"
                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md disabled:opacity-50 hover:bg-gray-400 transition duration-300 ease-in-out"
                disabled>
                Previous
            </button>

            <!-- Page Info -->
            <span id="pageInfo" class="self-center">Page 1</span>

            <!-- Tombol Next -->
            <button id="nextPage"
                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition duration-300 ease-in-out">
                Next
            </button>
        </div>
    </div>

    <!-- Success Message Box -->
    <div id="successBox"
        class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl mt-5 w-full">
        <p id="successMessage"></p>
    </div>

    <!-- Error Message Box -->
    <div id="errorBox" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mt-5 w-full">
        <p id="errorMessage"></p>
    </div>

    <!-- Overlay for background dimming -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50"></div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4">Hapus Transaksi</h2>
                <p>Apakah Anda yakin ingin menghapus transaksi ini?</p>
                <input type="hidden" id="deleteTransactionId">
                <div class="flex justify-end mt-4">
                    <button type="button" onclick="confirmDelete()"
                        class="bg-[#DD406C] text-white p-2 rounded-md text-sm hover:bg-[#c2385d] transition duration-300 ease-in-out">Hapus</button>
                    <button type="button" onclick="closeDeleteModal()"
                        class="bg-gray-500 text-white p-2 rounded-md text-sm ml-2 hover:bg-gray-400 transition duration-300 ease-in-out">Batal</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
    import { getDatabase, ref, onValue, remove, get, set } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2dBzwq2uiCnASi3PTruIKJ-nBVzlaMsc",
        authDomain: "iak-retail-kelompok-8.firebaseapp.com",
        databaseURL: "https://iak-retail-kelompok-8-default-rtdb.firebaseio.com",
        projectId: "iak-retail-kelompok-8",
        storageBucket: "iak-retail-kelompok-8.appspot.com",
        messagingSenderId: "530693322081",
        appId: "1:530693322081:web:270153437034677ad10120",
        measurementId: "G-W6448PF8BE"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Variables to manage pagination
    let transactionsPerPage = 6; // Limit rows per page
    let currentPage = 1;
    let transactions = [];

    // Load transactions and display them with pagination
    function loadTransactions() {
        const transactionRef = ref(database, 'transactions/');
        onValue(transactionRef, (snapshot) => {
            transactions = snapshot.val() ? Object.entries(snapshot.val()) : [];
            
            // Sort transactions by date (newest first)
            transactions.sort((a, b) => {
                const dateA = new Date(a[1].date);
                const dateB = new Date(b[1].date);
                return dateB - dateA;
            });
            
            displayTransactions();
        });
    }

    // Function to format number to Indonesian Rupiah format
    function formatRupiah(amount) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(amount);
    }

    // Display transactions for the current page
    function displayTransactions() {
    const transactionTable = document.getElementById('transactionTable');
    transactionTable.innerHTML = ''; // Clear the table

    const start = (currentPage - 1) * transactionsPerPage;
    const end = start + transactionsPerPage;
    const paginatedTransactions = transactions.slice(start, end);

    paginatedTransactions.forEach(([id, transaction]) => {
        const formattedPrice = formatRupiah(transaction.price); // Format the price
        const row = `<tr>
            <td class="border px-4 py-2">${transaction.transaction_id}</td>
            <td class="border px-4 py-2">${transaction.item}</td>
            <td class="border px-4 py-2">${transaction.date}</td>
            <td class="border px-4 py-2">${transaction.quantity}</td>
            <td class="border px-4 py-2">${formattedPrice}</td> <!-- Use formatted price -->
            <td class="border px-4 py-2 text-center">
                <button class="bg-[#DD406C] text-white p-2 rounded-md hover:bg-[#c2385d] transition duration-300 ease-in-out mt-2" onclick="openDeleteModal('${id}')">
                    <img src="{{ url_for('static', filename='svg/delete.svg') }}" alt="Delete" class="w-6 h-6 inline">
                </button>
            </td>
        </tr>`;
        transactionTable.innerHTML += row;
    });

    updatePaginationControls();
}

    // Update pagination controls (next, prev buttons)
    function updatePaginationControls() {
        const pageInfo = document.getElementById('pageInfo');
        const prevPageButton = document.getElementById('prevPage');
        const nextPageButton = document.getElementById('nextPage');

        // Update the page info text
        pageInfo.textContent = `Page ${currentPage} of ${Math.ceil(transactions.length / transactionsPerPage)}`;

        // Disable the Previous button if on the first page
        prevPageButton.disabled = currentPage === 1;

        // Disable the Next button if on the last page
        nextPageButton.disabled = currentPage === Math.ceil(transactions.length / transactionsPerPage);
    }

    // Navigate to the previous page
    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            displayTransactions();
        }
    });

    // Navigate to the next page
    document.getElementById('nextPage').addEventListener('click', () => {
        if (currentPage < Math.ceil(transactions.length / transactionsPerPage)) {
            currentPage++;
            displayTransactions();
        }
    });

    window.openDeleteModal = function (transactionId) {
        document.getElementById('deleteTransactionId').value = transactionId;
        document.getElementById('deleteModal').classList.remove('hidden');
        document.getElementById('modalOverlay').classList.remove('hidden');
    }

    window.closeDeleteModal = function () {
        document.getElementById('deleteModal').classList.add('hidden');
        document.getElementById('modalOverlay').classList.add('hidden');
    }

    // Function to show error message
    function showErrorMessage(message) {
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');

        errorMessage.textContent = message;
        errorBox.classList.remove('hidden'); // Show the error box

        // Set timeout to hide the error box after 3 seconds
        setTimeout(() => {
            hideErrorMessage();
        }, 3000); // 3000 milliseconds = 3 seconds
    }

    // Function to hide error message
    function hideErrorMessage() {
        const errorBox = document.getElementById('errorBox');
        errorBox.classList.add('hidden'); // Hide the error box
    }

    // ... existing code ...

window.confirmDelete = function () {
    const id = document.getElementById('deleteTransactionId').value;
    const transactionRef = ref(database, 'transactions/' + id);

    // First, get the transaction details
    get(transactionRef).then((snapshot) => {
        const transaction = snapshot.val();
        if (transaction) {
            // Extract the model (A, B, or C) from the item name
            const model = transaction.item.split(' ').pop();
            const quantity = transaction.quantity;

            // Update stock
            updateStock(model, quantity).then(() => {
                // After updating stock, remove the transaction
                remove(transactionRef).then(() => {
                    showSuccessMessage("Transaksi berhasil dihapus dan stok dikembalikan.");
                    closeDeleteModal();
                }).catch((error) => {
                    showErrorMessage("Terjadi kesalahan saat menghapus transaksi: " + error.message);
                });
            }).catch((error) => {
                showErrorMessage("Terjadi kesalahan saat memperbarui stok: " + error.message);
            });
        } else {
            showErrorMessage("Transaksi tidak ditemukan.");
        }
    }).catch((error) => {
        showErrorMessage("Terjadi kesalahan saat mengambil data transaksi: " + error.message);
    });
}

function updateStock(model, quantity) {
    const stockRef = ref(database, 'stock');
    return get(stockRef).then((snapshot) => {
        let stock = snapshot.val();
        if (!stock) {
            throw new Error("Data stok tidak ditemukan.");
        }

        // Update stock for each part
        const partsToUpdate = [`Roda ${model}`, `Frame ${model}`, `Stang ${model}`];
        partsToUpdate.forEach(part => {
            const partIndex = stock.findIndex(item => item.nama_produk === part);
            if (partIndex !== -1) {
                stock[partIndex].stock += quantity;
            } else {
                throw new Error(`Part ${part} tidak ditemukan dalam stok.`);
            }
        });

        // Update the stock in Firebase
        return set(stockRef, stock);
    });
}

// ... rest of the existing code ...

    function showSuccessMessage(message) {
        const successBox = document.getElementById('successBox');
        const successMessage = document.getElementById('successMessage');

        // Set the message and show the box
        successMessage.textContent = message;
        successBox.classList.remove('hidden');

        // Auto-hide after 3 seconds
        setTimeout(() => {
            successBox.classList.add('hidden');
        }, 3000);
    }

    // Initial load
    loadTransactions();
</script>

{% endblock %}