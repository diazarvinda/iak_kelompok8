{% extends 'main.html' %}
<!-- Extend main.html -->

{% block content %}
<div class="container mx-auto mt-8">

    <!-- Transaction Table -->
    <h1 class="text-5xl font-bold mb-6">Histori Transaksi</h1>

    <!-- Transaction Table Container -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="overflow-x-auto">
            <table class="table-auto w-full text-left border-collapse">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">ID</th>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">Item</th>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">Jumlah</th>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">Harga</th>
                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 uppercase border-b">Aksi</th>
                    </tr>
                </thead>
                <tbody id="transactionTable" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be dynamically populated here -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div id="paginationControls" class="flex justify-between mt-4">
            <!-- Tombol Previous -->
            <button id="prevPage"
                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md disabled:opacity-50 hover:bg-gray-400 transition duration-300 ease-in-out"
                disabled>
                Previous
            </button>

            <!-- Page Info -->
            <span id="pageInfo" class="self-center">Page 1</span>

            <!-- Tombol Next -->
            <button id="nextPage"
                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition duration-300 ease-in-out">
                Next
            </button>
        </div>
    </div>

    <!-- Success Message Box -->
    <div id="successBox"
        class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl mt-5 w-full">
        <p id="successMessage"></p>
    </div>

    <!-- Error Message Box -->
    <div id="errorBox" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mt-5 w-full">
        <p id="errorMessage"></p>
    </div>

    <!-- Overlay for background dimming -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50"></div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-6 rounded-lg shadow-lg z-20 w-full max-w-3xl min-h-[12vh]">
                <h2 class="text-xl font-bold mb-4">Edit Transaksi</h2>
                <form id="editForm">
                    <input type="hidden" id="editTransactionId">
                    <div class="mb-4">
                        <label for="editItem" class="block text-gray-700">Item</label>
                        <!-- Dropdown for Item with placeholder -->
                        <select id="editItem" class="border border-gray-300 rounded-md p-2 w-full">
                            <option id="currentItemPlaceholder" disabled selected>
                                <!-- Placeholder diatur dari JS -->
                            </option>
                            <option value="Sepeda Ontel A">Sepeda Ontel A</option>
                            <option value="Sepeda Ontel B">Sepeda Ontel B</option>
                            <option value="Sepeda Ontel C">Sepeda Ontel C</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="editQuantity" class="block text-gray-700">Jumlah</label>
                        <input type="number" id="editQuantity" class="border border-gray-300 rounded-md p-2 w-full">
                    </div>
                    <div class="mb-4">
                        <label for="editPrice" class="block text-gray-700">Harga</label>
                        <input type="number" id="editPrice" class="border border-gray-300 rounded-md p-2 w-full">
                    </div>
                    <!-- Tombol Simpan -->
                    <button type="submit"
                        class="bg-[#40DDC1] text-white rounded-md p-2 text-sm hover:bg-[#33b89d] transition duration-300 ease-in-out">
                        Simpan
                    </button>

                    <!-- Tombol Batal -->
                    <button type="button" onclick="closeEditModal()"
                        class="bg-gray-500 text-white p-2 text-sm rounded-md ml-2 hover:bg-gray-400 transition duration-300 ease-in-out">
                        Batal
                    </button>
                </form>
            </div>
        </div>
    </div>


    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4">Hapus Transaksi</h2>
                <p>Apakah Anda yakin ingin menghapus transaksi ini?</p>
                <input type="hidden" id="deleteTransactionId">
                <div class="flex justify-end mt-4">
                    <button type="button" onclick="confirmDelete()"
                        class="bg-[#DD406C] text-white p-2 rounded-md text-sm hover:bg-[#c2385d] transition duration-300 ease-in-out">Hapus</button>
                    <button type="button" onclick="closeDeleteModal()"
                        class="bg-gray-500 text-white p-2 rounded-md text-sm ml-2 hover:bg-gray-400 transition duration-300 ease-in-out">Batal</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2dBzwq2uiCnASi3PTruIKJ-nBVzlaMsc",
        authDomain: "iak-retail-kelompok-8.firebaseapp.com",
        databaseURL: "https://iak-retail-kelompok-8-default-rtdb.firebaseio.com",
        projectId: "iak-retail-kelompok-8",
        storageBucket: "iak-retail-kelompok-8.appspot.com",
        messagingSenderId: "530693322081",
        appId: "1:530693322081:web:270153437034677ad10120",
        measurementId: "G-W6448PF8BE"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Variables to manage pagination
    let transactionsPerPage = 6; // Limit rows per page
    let currentPage = 1;
    let transactions = [];

    // Load transactions and display them with pagination
    function loadTransactions() {
        const transactionRef = ref(database, 'transactions/');
        onValue(transactionRef, (snapshot) => {
            transactions = snapshot.val() ? Object.entries(snapshot.val()) : [];
            displayTransactions();
        });
    }

    // Function to format number to Indonesian Rupiah format
    function formatRupiah(amount) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(amount);
    }

    // Display transactions for the current page
    function displayTransactions() {
    const transactionTable = document.getElementById('transactionTable');
    transactionTable.innerHTML = ''; // Clear the table

    const start = (currentPage - 1) * transactionsPerPage;
    const end = start + transactionsPerPage;
    const paginatedTransactions = transactions.slice(start, end);

    paginatedTransactions.forEach(([id, transaction]) => {
        const formattedPrice = formatRupiah(transaction.price); // Format the price
        const row = `<tr>
            <td class="border px-4 py-2">${id}</td>
            <td class="border px-4 py-2">${transaction.item}</td>
            <td class="border px-4 py-2">${transaction.quantity}</td>
            <td class="border px-4 py-2">${formattedPrice}</td> <!-- Use formatted price -->
            <td class="border px-4 py-2">
                <button class="bg-[#FFC107] text-white p-2 rounded-md text-sm hover:bg-[#e6ac00] transition duration-300 ease-in-out" onclick="openEditModal('${id}', '${transaction.item}', ${transaction.quantity}, ${transaction.price})">
                    <img src="{{ url_for('static', filename='svg/edit.svg') }}" alt="Edit" class="w-6 h-6 inline">
                </button>
                <button class="bg-[#DD406C] text-white p-2 rounded-md text-sm hover:bg-[#c2385d] transition duration-300 ease-in-out" onclick="openDeleteModal('${id}')">
                    <img src="{{ url_for('static', filename='svg/delete.svg') }}" alt="Delete" class="w-6 h-6 inline">
                </button>
            </td>
        </tr>`;
        transactionTable.innerHTML += row;
    });

    updatePaginationControls();
}

    // Update pagination controls (next, prev buttons)
    function updatePaginationControls() {
        const pageInfo = document.getElementById('pageInfo');
        const prevPageButton = document.getElementById('prevPage');
        const nextPageButton = document.getElementById('nextPage');

        // Update the page info text
        pageInfo.textContent = `Page ${currentPage} of ${Math.ceil(transactions.length / transactionsPerPage)}`;

        // Disable the Previous button if on the first page
        prevPageButton.disabled = currentPage === 1;

        // Disable the Next button if on the last page
        nextPageButton.disabled = currentPage === Math.ceil(transactions.length / transactionsPerPage);
    }

    // Navigate to the previous page
    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            displayTransactions();
        }
    });

    // Navigate to the next page
    document.getElementById('nextPage').addEventListener('click', () => {
        if (currentPage < Math.ceil(transactions.length / transactionsPerPage)) {
            currentPage++;
            displayTransactions();
        }
    });

   // Modal functions (same as before)
    window.openEditModal = function (id, item, quantity, price) {
        document.getElementById('editTransactionId').value = id;
        document.getElementById('editQuantity').value = quantity;
        document.getElementById('editPrice').value = price;

        const placeholderOption = document.getElementById('currentItemPlaceholder');
        placeholderOption.textContent = `Current: ${item}`;
        placeholderOption.value = item;

        // Store initial values for comparison
        document.getElementById('editItem').dataset.initialValue = item;
        document.getElementById('editQuantity').dataset.initialValue = quantity;
        document.getElementById('editPrice').dataset.initialValue = price;

        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('modalOverlay').classList.remove('hidden');
    }

    window.openDeleteModal = function (transactionId) {
        document.getElementById('deleteTransactionId').value = transactionId;
        document.getElementById('deleteModal').classList.remove('hidden');
        document.getElementById('modalOverlay').classList.remove('hidden');
    }

    window.closeDeleteModal = function () {
        document.getElementById('deleteModal').classList.add('hidden');
        document.getElementById('modalOverlay').classList.add('hidden');
    }

    window.closeEditModal = function () {
        document.getElementById('editModal').classList.add('hidden');
        document.getElementById('modalOverlay').classList.add('hidden');
    }

    // Function to show error message
    function showErrorMessage(message) {
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');

        errorMessage.textContent = message;
        errorBox.classList.remove('hidden'); // Show the error box

        // Set timeout to hide the error box after 3 seconds
        setTimeout(() => {
            hideErrorMessage();
        }, 3000); // 3000 milliseconds = 3 seconds
    }

    // Function to hide error message
    function hideErrorMessage() {
        const errorBox = document.getElementById('errorBox');
        errorBox.classList.add('hidden'); // Hide the error box
    }

    // Event listener for the edit form submission
    document.getElementById('editForm').addEventListener('submit', function (event) {
        event.preventDefault();
        hideErrorMessage(); // Hide any previous error messages

        const id = document.getElementById('editTransactionId').value;
        const item = document.getElementById('editItem').value;
        const quantity = parseInt(document.getElementById('editQuantity').value);
        const price = parseFloat(document.getElementById('editPrice').value);

        // Get initial values from dataset
        const initialItem = document.getElementById('editItem').dataset.initialValue;
        const initialQuantity = parseInt(document.getElementById('editQuantity').dataset.initialValue);
        const initialPrice = parseFloat(document.getElementById('editPrice').dataset.initialValue);

        // Check for changes
        if (item === initialItem && quantity === initialQuantity && price === initialPrice) {
            showErrorMessage("Tidak ada perubahan yang dilakukan.");
            closeEditModal();
            return;
        }

        const updates = { item, quantity, price };

        const transactionRef = ref(database, 'transactions/' + id);
        update(transactionRef, updates).then(() => {
            showSuccessMessage("Transaksi berhasil diupdate.");
            closeEditModal();
        }).catch((error) => {
            showErrorMessage("Terjadi kesalahan: " + error.message);
        });
    });

    window.confirmDelete = function () {
        const id = document.getElementById('deleteTransactionId').value;
        const transactionRef = ref(database, 'transactions/' + id);
        remove(transactionRef).then(() => {
            showSuccessMessage("Transaksi berhasil dihapus.");
            closeDeleteModal();
        }).catch((error) => {
            alert("Terjadi kesalahan: " + error.message); // Keep this alert for error handling.
        });
    }

    function showSuccessMessage(message) {
        const successBox = document.getElementById('successBox');
        const successMessage = document.getElementById('successMessage');

        // Set the message and show the box
        successMessage.textContent = message;
        successBox.classList.remove('hidden');

        // Auto-hide after 3 seconds
        setTimeout(() => {
            successBox.classList.add('hidden');
        }, 3000);
    }

    // Initial load
    loadTransactions();
</script>

{% endblock %}