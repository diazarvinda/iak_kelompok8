{% extends 'main.html' %}

{% block content %}
<div class="container mx-auto mt-8">

    <div class="flex justify-between items-start mb-6">
        <!-- Transaction Table -->
        <h1 class="text-4xl font-bold">Status Pemesanan</h1>

        <div class="flex flex-col space-y-4">
            <!-- Success Message Box -->
            <div id="successBox"
                class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl w-64">
                <p id="successMessage"></p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6">
        {% if orders %}
        <div class="overflow-x-auto shadow-md rounded-lg text-xs">
            <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
                <thead>
                    <tr>
                        <th
                            class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600">
                            Order ID</th>
                        <th
                            class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600">
                            Tanggal</th>
                        <th
                            class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600">
                            Items</th>
                        <th
                            class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600">
                            Distributor</th>
                        <th
                            class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600">
                            Total Harga</th>
                        <th
                            class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600">
                            Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order_id, order in orders.items() %}
                    <tr>
                        <td class="py-2 px-4 border-b border-gray-200">{{ order.order_id }}</td>
                        <td class="py-2 px-4 border-b border-gray-200">{{ order.date }}</td>
                        <td class="py-2 px-4 border-b border-gray-200">
                            {% for item in order.cart %}
                            {{ item.product }} ({{ item.quantity }})<br>
                            {% endfor %}
                        </td>
                        <td class="py-2 px-4 border-b border-gray-200">{{ order.distributor }}</td>
                        <td class="py-2 px-4 border-b border-gray-200">Rp {{ order.total_price|int }}</td>
                        <td class="py-2 px-4 border-b border-gray-200">
                            <button onclick="confirmOrder('{{ order_id }}')"
                                class="bg-[#40DDC1] text-white rounded-md py-2 px-4 text-sm font-semibold hover:bg-[#33b89d] transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#40DDC1]">
                                Konfirmasi Pemesanan
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center text-gray-500">Tidak ada pemesanan saat ini.</p>
        {% endif %}
    </div>
</div>

<script>
    function showSuccess(message) {
        const successBox = document.getElementById('successBox');
        const successMessage = document.getElementById('successMessage');
        successMessage.textContent = message;
        successBox.classList.remove('hidden');
        setTimeout(() => {
            successBox.classList.add('hidden');
        }, 3000);
    }

    function confirmOrder(orderId) {
        fetch('/api/confirm_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: orderId
                }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.message) {
                    showSuccess(data.message);
                    setTimeout(() => {
                        location.reload(); // Reload the page to reflect the changes
                    }, 3000);
                } else {
                    showSuccess('Error: ' + data.error);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                showSuccess('An error occurred while confirming the order: ' + error.message);
            });
    }
</script>
{% endblock %}